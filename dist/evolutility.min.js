/*   evolutility v0.4   */
/*   (c) 2015 Olivier Giulieri   */
/*   https://github.com/evoluteur/evolutility   */
var Evol=Evol||{};Evol.hashLov={},Evol.ViewAction={},Evol.UI={html:{trTableEnd:"</tr></table>",TdTrTableEnd:"</td></tr></table>",clearer:'<div class="clearfix"></div>',emptyOption:'<option value=""> - </option>',glyphicon:"glyphicon glyphicon-",required:'<span class="evol-required">*</span>',buttonClose:'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'},label:function(a,b){return'<label for="'+a+'">'+b+"</label>"},fieldLabel:function(a,b){return'<div class="evol-field-label">'+this.label(a,b)+"</div>"},fieldLabelSpan:function(a,b){return'<span class="evol-field-label">'+this.label(a,b)+"</span>"},input:{text:function(a,b,c,d){var e="evo-field form-control "+(d||""),f='<input type="text" id="'+a+'" value="'+b;return b.indexOf('"')>-1&&(b=b.replace(/"/g,'"')),c&&(_.each(["id","min","max","maxlength","placeholder"],function(a){_.isUndefined(c[a])||(f+='" '+a+'="'+c[a])}),c.readonly&&(f+='" disabled="disabled'),e&&(f+='" class="'+e)),f+='">'},textInt:function(a,b,c,d){var e='<input class="evo-field form-control" type="number" id="'+a+'" value="'+b;return _.isUndefined(c)||(e+='" min="'+c),_.isUndefined(d)||(e+='" max="'+d),e+='" maxlength="12">'},textM:function(a,b,c,d){return'<textarea id="'+a+'" class="evo-field form-control" rows="'+d+'">'+b+"</textarea>"},textMJSON:function(a,b,c,d){return'<textarea id="'+a+'" rows="'+c+'" class="evol-json evo-field form-control"'+(d?" disabled":"")+">"+_.escape(JSON.stringify(b,null,"	"))+"</textarea>"},myType:function(a,b,c){return'<input type="'+a+'" id="'+b+'" value="'+c+'" class="evo-field form-control" size="15">'},date:function(a,b){return this.myType("date",a,b)},dateTime:function(a,b){return this.myType("datetime-local",a,b)},time:function(a,b){return this.myType("time",a,b)},typeFlag:function(a){return'<span class="input-group-addon">'+a+"</span>"},color:function(a,b){return'<input type="color" id="'+a+'" value="'+b+'" size="15">'},colorBox:function(a,b,c){return'<div class="evo-color-box" id="'+a+'" style="background-color:'+b+'" title="'+b+'">'+(c?"<span>"+c+"</span>":"")+"</div>"},checkbox:function(a,b){return'<input type="checkbox" id="'+a+(b?'" checked="checked':"")+'" value="1">'},checkbox2:function(a,b,c){return'<input type="checkbox" data-id="'+a+'" class="'+c+'"'+(b?' checked="checked"':"")+' value="1">'},checkboxLOV:function(a){var b="";for(var c in a){var d=a[c];b+='<input type="checkbox" id="'+d.id+'" value="'+d.id+'"/><label for="'+d.id+'">'+d.text+"</label> "}return b},radio:function(a,b,c,d,e){return'<label for="'+e+'"><input id="'+e+'" name="'+a+'" type="radio" value="'+b+(d?'" checked="checked':"")+'">'+c+"</label>&nbsp;"},lov:function(a,b,c,d){var e='<select class="evo-field form-control" id="'+a+'"><option value="'+b+'" selected>'+c+"</option>";return _.each(d,function(a){e+=this.option(a.id,a.text)}),e+="</select>"},img:function(a,b,c){return'<img id="'+a+'" src="'+b.replace(/"/g,'"')+(c?'" class="'+c:"")+'">'},hidden:function(a,b){return'<input type="hidden" name="'+a+'" id="'+a+'" value="'+b.replace(/"/g,'"')+'"/>'},selectBegin:function(a,b,c){return'<select id="'+a+'" class="form-control '+b+'">'+(c?Evol.UI.html.emptyOption:"")},select:function(a,b,c,d,e){return this.selectBegin(a,c,d)+this.options(e,b)+"</select>"},option:function(a,b,c){return'<option value="'+a+(c?'" selected':'"')+">"+b+"</option>"},options:function(a,b){var c=Evol.UI.input.option,d="";return _.each(a,function(a){d+=a.id===b?'<option value="'+a.id+'" selected="selected">'+a.text+"</option>":c(a.id,a.text)}),d}},toggleCheckbox:function(a,b){b?a.prop("checked","checked"):a.prop("checked",!1)},button:function(a,b,c){return'<button type="button" data-id="'+a+'" class="btn'+(c?" "+c:"")+'">'+b+"</button>"},buttonsIcon:function(a,b){return'<div data-id="'+a+'" class="glyphicon glyphicon-'+b+'" tabindex="0"></div>'},buttonsPlus:function(){return this.buttonsIcon("bPlus","plus-sign")},buttonsMinus:function(){return this.buttonsIcon("bMinus","minus-sign")},buttonsPlusMinus:function(){return this.buttonsPlus()+this.buttonsMinus()},link:function(a,b,c,d){var e='<a class="evo-field" href="'+encodeURI(c);return a&&(e+='" id="'+a),d&&(e+='" target="'+d),e+='">'+_.escape(b)+"</a>"},linkEmail:function(a,b){return b?this.link(a,b,"mailto:"+b):""},icon:function(a,b){return'<i class="'+(b?b+" ":"")+Evol.UI.html.glyphicon+a+'"></i>'},iconCustomize:function(a,b){return Evol.UI.iconId(a,b,"wrench")},iconId:function(a,b,c){return'<i class="'+Evol.UI.html.glyphicon+c+'" data-id="'+a+'" data-type="'+b+'"></i>'},menu:{hBegin:function(a,b,c){return"<"+b+' class="dropdown" data-id="'+a+'"><a href="#" class="dropdown-toggle" data-toggle="dropdown">'+Evol.UI.icon(c)+' <b class="caret"></b></a><ul class="dropdown-menu evo-dropdown-icons">'},hEnd:function(a){return"</ul></"+a+">"},hItem:function(a,b,c,d,e){var f='<li data-id="'+a;return d&&(f+='" data-cardi="'+d),"label"!==e&&(f+='" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="'+b),f+='"><a href="javascript:void(0);" data-id="'+a+'">'+Evol.UI.icon(c),"tooltip"!==e&&(f+="&nbsp;"+b),f+="</a></li>"}},modal:{alert:function(a,b){var c=$(this.HTMLModal("alert",a,b,[{id:"ok",text:Evol.i18n.bOK,"class":"btn-primary"}])).on("click","button",function(){c.remove()}).modal("show")},confirm:function(a,b,c,d,e){var f=$(this.HTMLModal(a,b,c,e)).on("click","button",function(a){var b=$(a.currentTarget).data("id");d&&d[b]&&d[b](),f.remove()}).modal("show")},HTMLModal:function(a,b,c,d){var e=function(a,b,c){return'<button data-id="'+a+'" type="button" class="btn '+c+'" data-dismiss="modal">'+b+"</button>"},f='<div class="modal fade" id="'+a+'" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">'+b+'</h4></div><div class="modal-body">'+c+'</div><div class="modal-footer">';return d||(d=[{id:"cancel",text:Evol.i18n.bCancel,"class":"btn-default"},{id:"ok",text:Evol.i18n.bOK,"class":"btn-primary"}]),_.each(d,function(a){f+=e(a.id,a.text,a["class"])}),f+="</div></div></div></div>"}},HTMLPanelBegin:function(a,b){return'<div data-pid="'+a.id+'" class="panel '+(a.css?a.css:b)+'"><div class="panel-heading '+(a.csslabel?a.csslabel:"")+'">'+Evol.UI.icon("chevron-up","evol-title-toggle")+'<h3 class="panel-title">'+a.label+"</h3>"+(a.label2?'<div class="evol-subtitle">'+a.label2+"</div>":"")+(a.help?'<p class="evo-panel-help">'+a.help+"</p>":"")+"</div>"},HTMLPanelEnd:function(){return"</div>"},HTMLEmptyPanel:function(a,b,c){return'<div class="'+b+" panel panel-"+c+'" data-id="'+a+'"></div>'},HTMLMsg:function(a,b,c){return'<div data-id="msg" class="evo-msg alert alert-'+(c||"info")+' alert-dismissable">'+this.html.buttonClose+"<strong>"+a+"</strong> <span>"+b+"</span></div>"},formatDate:function(a){if(!_.isUndefined(a)&&null!==a){var b=a.split("-");if(b.length>1)return b[1]+"/"+b[2]+"/"+b[0]}return""},formatTime:function(a){if(!_.isUndefined(a)&&null!==a&&""!==a){var b=a.split(":"),c=parseInt(b[0],10);return c>12?c-12+":"+b[1]+" PM":c+":"+b[1]+" AM"}return""},formatDateTime:function(a){if(!_.isUndefined(a)&&null!==a&&""!==a){var b=a.split("T");return b.length>1?this.formatDate(b[0])+", "+this.formatTime(b[1]):this.formatDate(b[0])}return""},insertCollection:function(a,b){_.each(b,function(b){a.create(b)})},capitalize:function(a){return a&&a.length>0?a.substring(0,1).toUpperCase()+a.substring(1):""},trim:function(a){return _.isString(a)&&""!==a?a.replace(/^\s+|\s+$/g,""):""},setVisible:function(a,b){b?a.show():a.hide()},cr2br:function(a){return a.replace(/[\r\n]/g,"<br>")},addRemClass:function(a,b,c){return b?a.addClass(c):a.removeClass(c),b}},Evol.UI.Charts={colors:["1f77b4","ff7f0e","2ca02c","d62728","9467bd","8c564b","e377c2","7f7f7f","bcbd22","17becf"],_colorsList:function(a){return this.colors.slice(0,a).join(",")},URL:"http://chart.apis.google.com/chart",_HTML:function(a,b){return'<label class="evol-chart-title">'+a+'</label><img src="'+b+'">'},Pie:function(a,b,c,d,e){var f=e?e:"390x200",g=this.URL+"?chd=t:"+b.join(",")+"&chco="+this._colorsList(b.length)+"&amp;chl="+c.join("|")+"&amp;cht=p&amp;chs="+f;return this._HTML(a,g,d||"panel-default")},Bars:function(a,b,c,d,e){var f=e?e:"360x200",g=_.max(b),h=this.URL+"?chbh=a&amp;chs="+f+"&cht=bvg&chco="+this._colorsList(b.length)+"&chds=0,"+g+"&amp;chd=t:"+b.join("|")+"&amp;chp=0.05&amp;chts=676767,10.5&amp;chdl="+c.join("|");return this._HTML(a,h,d)}};var Evol=Evol||{};Evol.i18n={LOCALE:"EN",getLabel:function(a,b,c){var d;if(a.indexOf(".")>-1){var e=a.split(".");d=this[e[0]][e[1]]}else d=this[a];return b&&d&&(d=d.replace("{0}",b),c&&(d=d.replace("{1}",c))),d},View:"View",bView:"View",bEdit:"Edit",bMini:"Mini",bNew:"New",NewEntity:"New {0}",Selections:"Selections",Selection:"Selection",bExport:"Export",bCharts:"Charts",bDelete:"Delete",bAll:"All",bList:"List",bFilter:"Filter",bCards:"Cards",bJSON:"JSON",bSave:"Save",bSaveAdd:"Save and Add Another",bOK:"OK",bCancel:"Cancel",saved:"{0} saved.",unSavedTitle:"Changes pending",unSavedChanges:'Do you want to save the changes you made to "{0}"?',warnNoSave:"Your changes will be lost if you don't save them.",bNoSave:"Don't Save",deleteX:"Delete {0}",delete1:'Do you really want to delete the {0} "{1}"?',deleteN:"Delete {0} {1}?",deleted1:"{0} deleted.",notFound:"Item not found.",notFoundMsg:"No {0} found.",notFoundMsgId:'No {0} found for ID="{1}".',NoChange:"No Change",NoX:"No {0}",yes:"Yes",no:"No",none:"None",na:"N/A",nodata:"No data available.",nopix:"No picture.",nochart:"No charts available.",badchart:"Not enough information provided to draw charts.",range:"{0} - {1} of {2} {3}",selected:"{0} selected",sgn_money:"$",sgn_email:"@",status:{added:'New {0} "{1}" added.',updated:'{0} "{1}" updated.',deleted:'{0} "{1}" deleted.'},validation:{incomplete:"Incomplete information",invalid:"Invalid format.",invalidList:'{0} values in "{1}" are invalid.',invalidList1:'1 value in "{1}" is invalid.',empty:'"{0}" must have a value.',email:'"{0}" must be a valid email formatted like "name@domain.com".',integer:'"{0}" must only use numbers.',decimal:'"{0}" must be a valid decimal numbers.',money:'"{0}" must be a valid number.',date:'"{0}" must be a valid date, format must be "MM/DD/YYYY" like "12/24/2015".',datetime:'"{0}" must be a valid date/time, format must be "MM/DD/YYYY hh:mm AM/PM" like "12/24/2015 10:30 AM".',time:'"{0}" must be a valid date/time, format must be "hh:mm AM/PM" like "10:30 AM".',max:'"{0}" must be smaller or equal to {1}.',min:'"{0}" must be greater or equal to {1}.',maxlength:'"{0}" must be {1} characters long maximum.',minlength:'"{0}" must be at least {1} characters long.',minmaxlength:'"{0}" must be between {1} and {2} characters long.',regex:'"{0}" is not of the expected format.'},error:"Error",charts:{aByB:"{0} by {1}",aB:"{0}: {1}"},"export":{ExportEntity:"Export {0}",ExportEntities:"Export {0}",preview:"Export preview",header:"Header",options:"options",separator:"Separator",firstLine:"First line for field names",format:"Export format",xpFields:"Fields to include in the export",IDkey:"ID",allFields:"Show all fields",formatCSV:"Comma separated (CSV, TXT, XLS...)",formatHTML:"HTML",formatSQL:"SQL Insert Statements (SQL)",formatTAB:"Tab separated values (TXT)",formatXML:"XML",formatJSON:"Javascript Object Notation (JSON)",XMLroot:"Element name",SQL:"SQL Options",SQLTable:"Table name",SQLTrans:"In transaction",SQLIdInsert:"Identity insert",DownloadEntity:"Download {0}"},filters:{sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sFinish:"finishes with",sInList:"any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewCond:"New filter condition",bAddCond:"Add condition",bUpdateFilter:"Update filter",bSubmit:"Submit",bCancel:"Cancel"},prev:"Previous",next:"Next",finish:"Finish !"};var Evol=Evol||{};Evol.Dico=function(){var a=Evol.UI,b=a.input,c=Evol.i18n,d={text:"text",textml:"textmultiline",bool:"boolean","int":"integer",dec:"decimal",money:"money",date:"date",datetime:"datetime",time:"time",lov:"lov",list:"list",formula:"formula",email:"email",pix:"image",doc:"document",url:"url",color:"color",hidden:"hidden"};return{fieldTypes:d,fieldOneEdit:{field:function(a,c,d,e,f){a.push(b[d](e,f,c,null))},text:function(a,c,d,e){a.push(b.text(d,e,c,null))},textmultiline:function(a,c,d,e){if(null===c.height)c.height=5;else{var f=parseInt(c.height,10);1>f&&(c.height=5)}a.push(b.textM(d,e,c.maxlength,c.height))},"boolean":function(a,c,d,e){a.push(b.checkbox(d,e))},integer:function(a,c,d,e){a.push(b.textInt(d,e,c.max,c.min))},decimal:function(a,c,d,e){a.push(b.textInt(d,e,c.max,c.min))},money:function(a,c,d,e){a.push('<div class="input-group">',b.typeFlag("$"),b.textInt(d,e),"</div>")},date:function(a,c,d,e){a.push(b.date(d,e))},datetime:function(a,c,d,e){a.push(b.dateTime(d,e))},time:function(a,c,d,e){a.push(b.time(d,e))},lov:function(a,c,d,e){a.push(b.select(d,e,"",!0,c.list))},list:function(a,b,c){a.push('<div id="',c,'" class="w-100 form-control"></div>')},email:function(a,d,e,f){a.push('<div class="input-group">',b.typeFlag(c.sgn_email),b.text(e,f,d),"</div>")},url:function(a,c,d,e){a.push(b.text(d,e,c))},image:function(a,d,e,f,g){""!==f?a.push('<img src="',".."===f.substr(0,2)?f:g+f,'" class="img-thumbnail">'):a.push('<p class="">',c.nopix,"</p>"),a.push(b.text(e,f,d,null))},color:function(a,c,d,e){a.push(b.color(d,e))},hidden:function(a,c,d,e){a.push(b.hidden(d,e))},formula:function(a,c,d,e){a.push('<div class="evol-ellipsis">'+b.text(d,e,c,null)+"</div>")}},fieldConditions:{eq:function(a,b){return b==a},ne:function(a,b){return b!=a},gt:function(a,b){return a>b},lt:function(a,b){return b>a},bw:function(a,b,c){return!(b>a||a>c)},sw:function(a,b){return 0===a.toLocaleLowerCase().indexOf(b)},ct:function(a,b){return a?a.toLocaleLowerCase().indexOf(b)>-1:!1},fw:function(a,b){var c=a.length,d=b.length;return d>c?!1:a.toLocaleLowerCase().substring(c-d)===b},"null":function(a){return""==a||_.isUndefined(a)},nn:function(a){return!(_.isUndefined(a)||""==a)},"in":function(a,b){return _.contains(b.split(","),a)},1:function(a){return a},0:function(a){return!a}},viewIsOne:function(a){return"new"===a||"edit"===a||"view"===a||"json"===a},viewIsMany:function(a){return"list"===a||"cards"===a||"charts"===a||"bubbles"===a},fieldInCharts:function(a){return(_.isUndefined(a.viewcharts)||a.viewcharts)&&(a.type===d.lov||a.type===d.bool||a.type===d["int"]||a.type===d.money)},isNumberType:function(a){return a===d["int"]||a===d.dec||a===d.money},isDateOrTimeType:function(a){return a===d.date||a===d.datetime||a===d.time},getFields:function(a,b){function c(a){a&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){"panel-list"!=a.type&&c(a)}):d.push(a)}var d=[];return c(a),_.isFunction(b)&&(d=_.filter(d,b)),d},getFieldTypedValue:function(a,b){switch(a.type){case d.bool:return b.prop("checked");case d["int"]:return parseInt(b.val(),10);case d.dec:case d.money:return parseFloat(b.val());case d.list:return b.select2("val");default:return b.val()}},getSubCollecs:function(a){function b(a){"panel-list"===a.type?c[a.attribute]=a:"panel"!==a.type&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){"panel-list"===a.type?c[a.attribute]=a:"panel"!==a.type&&b(a)}):c[a.attribute]=a}var c={};return b(a),c},lovText:function(a,b,c,d){if(a.list&&a.list.length>0&&c){a.id in c||(c[a.id]={});var e=c[a.id];if(b in e)return e[b];var f=_.find(a.list,function(a){return a.id==b});if(f){var g=_.escape(f.text);return""==f.icon||_.isUndefined(f.icon)||(g='<img src="'+d+f.icon+'"> '+g),e[b]=g,g}}return""},lovTextNoPix:function(a,b){var c=_.find(a.list,function(a){return a.id==b});return c?c.text:""},filterModels:function(a,b){return b.length?a.filter(function(a){for(var c=!0,d=Evol.Dico.fieldConditions,e=0,f=b.length;f>e&&c&&c!==!1;e++){var g=b[e],h=a.get(g.field.value);_.isUndefined(h)&&(h=""),c=d[g.operator.value](h,g.value.value,g.value.value2)}return c}):a},HTMLField4Many:function(c,e,f,g){switch(c.type){case d.bool:if("true"===e||"1"==e)return a.icon("ok");break;case d.lov:if(""!==e)return Evol.Dico.lovText(c,e,f,g);break;case d.list:if(_.isString(e)&&(e=e.split(",")),e&&e.length){var h=[];return _.each(e,function(a){h.push(Evol.Dico.lovText(c,a,f,g))}),h.join(", ")}return e;case d.date:return a.formatDate(e);case d.time:return a.formatTime(e);case d.datetime:return a.formatDateTime(e);case d.pix:if(e&&e.length)return b.img(c.id,g+e,"img-thumbnail");break;case d.money:var i=parseFloat(e);if(!isNaN(i))return"$"+i.toFixed(2);break;case d.email:return a.linkEmail(c.id,e);case d.url:return a.link(c.id,e,e,c.id);default:return e}return""},HTMLField4One:function(b,c,e,f,g,h){var i=[];if("mini"===f?i.push('<div class="evol-mini-label">',this.HTMLFieldLabel(b,f),'</div><div class="evol-mini-content">'):h||i.push(this.HTMLFieldLabel(b,f||"edit")),b.readonly||"view"===f){switch(i.push('<div class="disabled evo-rdonly" id="',c),b.type===d.textml&&b.height>1&&i.push('" style="height:',b.height,"em;overflow-y: auto;"),i.push('">'),b.type){case d.formula:i.push('<div id="',c,'" class="form-control evol-ellipsis">',b.formula(),"</div>");break;case d.color:i.push('<div id="',c,'" class="form-control">',e,"</div>");break;case d.email:i.push(a.linkEmail(c,e));break;case d.url:i.push(a.link(c,e,e,c));break;default:i.push(this.HTMLField4Many(b,e,{},g))}i.push("&nbsp;</div>")}else Evol.Dico.fieldOneEdit[b.type](i,b,c,e,g);return"mini"===f&&i.push("</div>"),i.join("")},HTMLFieldLabel:function(b,c){var d=[];return d.push('<div class="evol-field-label" id="',b.id,'-lbl"><label class="control-label ',b.csslabel?b.csslabel:"",'" for="',b.id,'">',b.label),"view"!=c&&b.required&&d.push(a.html.required),b.help&&""!==b.help&&d.push(a.icon("question-sign","")),d.push("</label></div>"),d.join("")},HTMLFieldLink:function(a,b,c,d,e,f){var g="";return e||(g+='<a href="'+(f?f:"javascript:void(0);")+'" id="'+a+'" class="evol-nav-id">'),d&&(g+='<img class="evol-many-icon" src="'+d+'">'),g+=c,e||(g+="</a>"),g},bbComparator:function(a){return function(b){return b.get(a)}},bbComparatorText:function(a){return function(b,c){return(b.get(a)||"").localeCompare(c.get(a)||"")}},sortingText:function(a){return function(b,c){return b[a]<c[a]?1:c[a]<b[a]?-1:0}},getRoute:function(){var a=window.location.href,b=a.indexOf("#");return b>-1?a.substr(b+1):""},setRoute:function(a,b,c,d,e,f){if(!_.isUndefined(a)){var g=c+"/"+d;e&&(g+="/"+e),g!==this.getRoute()&&a.navigate("#"+g,{trigger:f})}_.isUndefined(this._$headTitle)&&(this._$headTitle=$("#headTitle")),this._$headTitle.html(b)}}}();var Evol=Evol||{};Evol.ViewMany=function(){var a=Evol.UI,b=Evol.Dico,c=Evol.i18n;return Backbone.View.extend({viewName:"Many",viewType:"many",editable:!1,cardinality:"n",options:{style:"panel-info",pageSize:20,pageIndex:0,autoUpdate:!1,selectable:!1,links:!0,noDataString:c.nodata,iconsPath:"pix/",fieldsetFilter:function(a){return a.viewmany}},events:{"click .evol-sort-icons>i":"click_sort","click .pagination>li":"click_pagination","change .list-sel":"click_selection",'change [data-id="cbxAll"]':"click_checkall"},initialize:function(a){var b=localStorage.getItem(a.uiModel.id+"-sort"),c=this;if(_.extend(this,this.options,a),this.mode=this.mode||"",this._filter=[],this.autoUpdate&&this.collection&&this.collection.on("change",function(){c.render()}),this.router||this.$el.on("click",".evol-nav-id",function(a){c.click_navigate(a)}),null!==b){var d=b.split("-"),e=this.getField(d[0]);d.length>1&&!_.isUndefined(e)&&this.sortList(e,"down"===d[1],!0,!0)}},render:function(){var c=this.collection.models;return this.collection.length?(c=b.filterModels(c,this._filter),this._render(c)):this.$el.html(a.HTMLMsg(this.noDataString,"","info")),this.setTitle()},_HTMLbody:function(a,b,c,d,e,f){var g,h,i=this.collection.models,j=e>0?e*c:0,k=_.min([i.length,j+c]),l=d?(this.iconsPath||"")+d:null;if(k>0){var m=this.getItemRoute();for(h=j;k>h;h++)g=i[h],this.HTMLItem(a,b,g,l,f,m)}},_render:function(){alert("_render must be overwritten")},_HTMLField:function(a,c){var d;if("formula"===a.type)d='<div class="disabled evo-rdonly evol-ellipsis">'+(this.model?a.formula(this.model):"")+"</div>";else if(d=b.HTMLField4Many(a,c,Evol.hashLov,this.iconsPath||""),"list"===a.type)return _.escape(d);return d},_HTMLCheckbox:function(b){return a.input.checkbox2(b,!1,"list-sel")},setCollection:function(a){return this.collection=a,this.render()},getCollection:function(){return this.collection},setFilter:function(a){return this._filter=a,this},getFilter:function(){return this._filter},setTitle:function(){return $(this.titleSelector).html(this.getTitle()),this},getTitle:function(){return a.capitalize(this.uiModel.entities)+" "+this.viewName},getFields:function(){if(!this._fields){this._fields=b.getFields(this.uiModel,this.fieldsetFilter),this._fieldHash={};var a=this._fieldHash;_.each(this._fields,function(b){a[b.id]=b})}return this._fields},getField:function(a){return this._fieldHash||this.getFields(),this._fieldHash[a]},setPage:function(a){var b=[],c=this.getFields(),d=this.pageSize,e=this.collection.length,f=this.pageSummary(a,d,e);return this._HTMLbody(b,c,d,this.uiModel.icon,a,this.selectable),this._$body().html(b.join("")),b=[],this._HTMLpaginationBody(b,a,d,e),this.$(".evo-pagination").html(b.join("")),this.$(".evo-many-summary").html(f),this.pageIndex=a,this.$el.trigger("status",f),this},getPage:function(){return this.pageIndex},_$Selection:function(){return this.$(".list-sel:checked").not('[data-id="cbxAll"]')},getSelection:function(){return this.selectable?_.map(this._$Selection().toArray(),function(a){return $(a).data("id")}):[]},setSelection:function(a){if(this.selectable&&a.length>0){var b=[];_.each(a,function(a){b.push("[data-mid="+a+"] .list-sel")}),this.$(b.join(",")).prop("checked",!0)}return this},pageSummary:function(a,b,d){if(0===d)return"";if(1===d)return d+" "+this.uiModel.entity;if(b>=d)return d+" "+this.uiModel.entities;var e,f=(a||0)*b+1;return e=_.min(1>a?[b,d]:[f+b-1,d]),c.range.replace("{0}",f).replace("{1}",e).replace("{2}",d).replace("{3}",this.uiModel.entities)},_HTMLpagination:function(a,b,c,d){d>c&&(a.push('<ul class="evo-pagination pagination pagination-sm">'),this._HTMLpaginationBody(a,b,c,d),a.push("</ul>"))},_HTMLpaginationBody:function(a,b,c,d){if(d>c){var e,f=Math.ceil(d/c),g=b+1,h=function(b){a.push("<li",g===b?' class="active"':"",' data-id="',b,'"><a href="javascript:void(0)">',b,"</a></li>")},i=function(a,b){for(var c=a;b>=c;c++)h(c)},j=function(){a.push('<li class="disabled"><a href="javascript:void(0)">...</a></li>')};a.push('<li data-id="prev"',1===g?' class="disabled"':"",'><a href="javascript:void(0)">&laquo;</a></li>'),h(1),g>4&&f>6?(5===g?h(2):j(),e=_.min([g+2,f]),i(_.max([2,g-2]),e)):(e=_.min([_.max([5,g+2]),f]),i(2,e)),f>e&&f>g+2&&(j(),h(f)),a.push('<li data-id="next"',f>g?"":' class="disabled"','><a href="javascript:void(0)">&raquo;</a></li>')}},sortList:function(a,c,d,e){var f=this.collection,g=b.fieldTypes;if(!_.isUndefined(f)){var h=this.getSelection();f.comparator=a.type==g.text||a.type==g.textml||a.type==g.email?b.bbComparatorText(a.id):a.value?a.value:b.bbComparator(a.id),f.sort(),c&&f.models.reverse(),this.setPage(0);var i=c?"down":"up";d||localStorage.setItem(this.uiModel.id+"-sort",a.id+"-"+i),this.setSelection(h),e||this.$el.trigger("sort.many",{id:a.id,direction:i})}return this},getItemRoute:function(){var a=this.router,b=null;return a&&(b="#"+this.uiModel.id+"/view/"),b},click_navigate:function(a){var b=$(a.currentTarget).closest("[data-mid]").data("mid");a.type="navigate.many",this.$el.trigger(a,{id:b})},click_sort:function(a){var b=$(a.currentTarget),c=b.parent().data("fid"),d=this.getField(c),e=b.attr("class").indexOf("-down")>0;this.sortList(d,e),b.addClass("evol-last-sort")},click_pagination:function(a){this.$el.trigger("paginate.many",{id:$(a.currentTarget).closest("li").data("id")})},click_selection:function(){this.$el.trigger("selection.many")},click_checkall:function(){var a=this.$('[data-id="cbxAll"]').prop("checked");this.$(".list-sel").prop("checked",a),this.$el.trigger("selection.many")}})}(),Evol.ViewMany.Cards=Evol.ViewMany.extend({viewName:"cards",_render:function(a){var b=[],c=this.pageSize||50,d=this.pageSummary(0,c,a.length);return b.push('<div class="evol-many-cards"><div class="evol-cards-body">'),this._HTMLbody(b,this.getFields(),c,this.uiModel.icon,0,this.selectable),b.push("</div>",Evol.UI.html.clearer),this._HTMLpagination(b,0,c,a.length),b.push('<div class="evo-many-summary">',d,"</div>","</div>"),this.$el.html(b.join("")),this},_$body:function(){return this.$(".evol-cards-body")},HTMLItem:function(a,b,c,d,e,f){var g,h=this,i=Evol.Dico.fieldTypes,j=this.links!==!1;return a.push('<div class="panel ',this.style,'">'),_.each(b,function(b,k){if(b.value?g=b.value(c):b.type===i.color?(g=c.escape(b.attribute||b.id),g=Evol.UI.input.colorBox(b.id,g,g)):g=h._HTMLField(b,c.escape(b.attribute||b.id)),0===k){a.push('<div data-mid="',c.id,'">');var l=h.uiModel.badge;l&&(a.push('<span class="badge pull-right">'),_.isFunction(l)?a.push(l(c)):_.isString(l)&&a.push(c.escape(l)),a.push("</span>")),a.push("<h4>",e?h._HTMLCheckbox(c.id):"",Evol.Dico.HTMLFieldLink("fg-"+b.id,b,g,d,!j,f?f+c.id:null),"</h4></div>")}else a.push("<div><label>",b.labelcards?b.labelcards:b.label,":</label> ",g,"</div>")}),a.push("</div>"),this}}),Evol.ViewMany.Charts=Evol.ViewMany.extend({viewName:"charts",options:{style:"panel-info",fieldsetFilter:Evol.Dico.fieldInCharts,autoUpdate:!1},events:{"click .evo-chart-config":"changeChartType"},render:function(){var a=[];return this.entityName=Evol.UI.capitalize(this.uiModel.entities),this.collection&&this.collection.length>0?(a.push('<div class="evol-many-',this.viewName,'">'),this._HTMLcharts(a,this.style,this.sizes),a.push("</div>")):a.push(Evol.UI.HTMLMsg(Evol.i18n.nodata,"","info")),this.$el.html(a.join("")),this.setTitle()},_HTMLcharts:function(a,b,c){var d,e=Evol.UI,f=Evol.Dico,g=Evol.i18n,h=f.fieldTypes,i=(this.uiModel,this.collection.models),j=this.iconsPath||"",k=this.getFields(),l={},m=this.entityName;if(k&&k.length){var n,o;_.each(k,function(k){var p,q,r=[],s=[],t=k.type===h.lov||k.type===h.list;if(k.type===h.bool){n=_.countBy(i,function(a){return a.get(k.id)===!0});for(q in n)p=n[q],o="true"===q?k.labeltrue||g.yes:k.labelfalse||g.no,r.push(p),s.push(o+" ("+p+")")}else{n=_.countBy(i,function(a){return a.get(k.id)});for(q in n)p=n[q],o="undefined"===q?g.na:""===q||"null"===q?g.none:t?k.list&&k.list.length&&k.list[0].icon?f.lovTextNoPix(k,q):f.lovText(k,q,Evol.hashLov,j):q,r.push(p),s.push(o+" ("+p+")")}d=k.typechart||(k.type===h.lov?"pie":"bars"),a.push('<div class="evol-chart-holder panel '+b+'">'),a.push('<div class="glyphicon glyphicon-cog evo-chart-config pull-right" data-id="'+k.id+'" data-ctype="'+d+'"></div>'),a.push('<div class="chart-holder">'),l[k.id]={field:k,data:r,labels:s,style:b,sizes:c},"pie"===d?a.push(e.Charts.Pie(k.labelcharts?k.labelcharts:g.getLabel("charts.aByB",m,k.label),r,s,b,c)):"bars"===d&&a.push(e.Charts.Bars(k.labelcharts?k.labelcharts:g.getLabel("charts.aB",m,k.label),r,s,b,c)),a.push("</div><br></div>")}),this._cData=l}else a.push(e.HTMLMsg(g.nochart,g.badchart));a.push(e.html.clearer)},setPage:function(){},changeChartType:function(a){var b=Evol.i18n,c=$(a.currentTarget),d=c.data("id"),e=c.data("ctype"),f=Evol.UI.Charts,g=this._cData[d],h=g.field,i=c.parent().find(".chart-holder");"pie"===e?(i.html(f.Bars(h.labelcharts?h.labelcharts:b.getLabel("charts.aB",this.entityName,h.label),g.data,g.labels,g.style,g.sizes)),c.data("ctype","bars")):(i.html(f.Pie(h.labelcharts?h.labelcharts:b.getLabel("charts.aByB",this.entityName,h.label),g.data,g.labels,g.style,g.sizes)),c.data("ctype","pie"))}}),Evol.ViewMany.List=Evol.ViewMany.extend({viewName:"list",fieldsetFilter:function(a){return a.viewmany||a.viewlist},_render:function(a){var b=[],c=this,d=this.getFields(),e=this.pageSize||50,f=this.links!==!1;b.push('<div class="evol-many-list">','<table class="table table-bordered',f?" table-hover":"",'"><thead><tr>'),this.selectable&&b.push('<th class="list-td-sel">',this._HTMLCheckbox("cbxAll"),"</th>"),_.each(d,function(a){c._HTMLlistHeader(b,a)}),b.push("</tr></thead><tbody>"),this._HTMLbody(b,d,e,this.uiModel.icon,0,this.selectable),b.push("</tbody></table>"),this._HTMLpagination(b,0,e,a.length),b.push('<div class="evo-many-summary">',this.pageSummary(this.pageIndex,e,a.length),"</div>","</div>"),this.$el.html(b.join(""))},_$body:function(){return this.$(".table > tbody")},HTMLItem:function(a,b,c,d,e,f){var g,h=this,i=h.uiModel.badge,j=this.links!==!1,k=Evol.Dico.fieldTypes;a.push('<tr data-mid="',c.id,'">'),e&&a.push('<td class="list-td-sel">',this._HTMLCheckbox(c.id),"</td>"),_.each(b,function(b,e){g=b.type===k.color?Evol.UI.input.colorBox(b.id,c.escape(b.attribute||b.id)):b.value?b.value(c):h._HTMLField(b,c.escape(b.attribute||b.id)),0===e&&(g=Evol.Dico.HTMLFieldLink("fv-"+b.id,b,g,d,!j,f?f+c.id:null),i&&(g+='<span class="badge badge-list">',_.isFunction(i)?g+=i(c):_.isString(i)&&(g+=c.escape(i)),g+="</span>")),b.type===k.textml?a.push('<td class="evol-ellipsis">',g,"</td>"):a.push("<td>",g,"</td>")}),a.push("</tr>")},_HTMLlistHeader:function(a,b){a.push('<th><span id="',b.id,'-lbl">',b.labellist||b.labelmany||b.label),b.sortable!==!1&&a.push('<span class="evol-sort-icons" data-fid="',b.id,'">',Evol.UI.icon("chevron-up"),Evol.UI.icon("chevron-down"),"</span>"),a.push("</span></th>")}});var Evol=Evol||{};Evol.ViewOne=function(){var a=Evol.UI,b=a.input,c=Evol.i18n,d=Evol.Dico,e=d.fieldTypes;return Backbone.View.extend({viewName:"One",viewType:"one",cardinality:"1",editable:!0,events:{"click .evol-buttons>button":"click_button","click .evol-title-toggle":"click_toggle","click ul.evol-tabs>li>a":"click_tab","click label>.glyphicon-question-sign":"click_help",'click [data-id="bPlus"],[data-id="bMinus"]':"click_detailsAddDel",'keyup [data-id="bPlus"],[data-id="bMinus"]':"click_detailsAddDel"},options:{style:"panel-info",button_addAnother:!1,titleSelector:"#title",iconsPath:"pix/"},initialize:function(a){_.extend(this,this.options,a),this.mode=this.mode||this.viewName,this._tabId=!1,this._uTitle=!_.isUndefined(this.titleSelector)&&""!==this.titleSelector,this._subCollecs=this._subCollecsOK=!1},render:function(){var a=[];return this._render(a,this.mode),this.$el.html(a.join("")),this.custOn=!1,this.postRender(),this.setData(this.model,!0),this},postRender:function(){},getFields:function(){if(!this._fields){this._fields=d.getFields(this.uiModel,this.fieldsetFilter),this._fieldHash={};var a=this;_.each(this._fields,function(b){a._fieldHash[b.id]=b})}return this._fields},getFieldsHash:function(){return this._fields||this.getFields(),this._fieldHash},getSubCollecs:function(){return this._subCollecsOK||(this._subCollecs=d.getSubCollecs(this.uiModel),this._subCollecsOK=!0),this._subCollecs},setModel:function(a){return this.model=a,this.clearMessages().setData(a,!0)},getModel:function(){return this.model},setUIModel:function(a){return this.uiModel=a,this.clearCache().render()},getUIModel:function(){return this.uiModel},getTitle:function(){if(this.model){if(this.model.isNew())return c.getLabel("NewEntity",this.uiModel.entity);var b=this.uiModel.leadfield;return _.isFunction(b)?b(this.model):this.model.get(b)}return a.capitalize(this.uiModel.entity)},getData:function(a){var b=this,c=this.getFields(),e={},f=this.getSubCollecs();if(a){var g=function(a){return a.readonly!==!0};c=_.filter(c,g),f=_.filter(f,g)}return _.each(c,function(a){e[a.id]=b.getFieldValue(a)}),f&&_.each(f,function(a){var c,f,g=b.$('[data-pid="'+a.id+'"] tbody tr').not('[data-id="nodata"]').toArray(),h=[];_.each(g,function(b){c={},f=$(b).children(),_.each(a.elements,function(a,b){c[a.id]=d.getFieldTypedValue(a,f.eq(b).find("input,select,textarea").eq(0))
}),h.push(c)}),e[a.attr||a.id]=h}),e},setData:function(b,f){if(_.isUndefined(b)||null===b)this.clear();else{var g,h,i,j=this,k=this.getSubCollecs(),l=this.iconsPath;_.each(this.getFields(),function(k){if(g=j.$field(k.id),h=f?k.value?k.value(b):b.get(k.attribute||k.id):b[k.attribute||k.id],k.readonly)switch(k.type){case e.pix:i=h?'<img src="'+l+h+'" class="img-thumbnail">':'<p class="">'+c.nopix+"</p>",g.val(h).prev().remove(),g.before(i);break;case e.textml:g.html(a.cr2br(h));break;case e.formula:g.html(k.formula(b));break;default:g.text(d.HTMLField4Many(k,_.isUndefined(h)?"":h,Evol.hashLov,l)+" ")}else switch(k.type){case e.lov:var m=g.children().removeAttr("selected");""!==h&&m.filter("[value="+h+"]").prop("selected","selected");break;case e.bool:g.prop("checked",h?"checked":!1);break;case e.pix:i=h?'<img src="'+l+h+'" class="img-thumbnail">':'<p class="">'+c.nopix+"</p>",g.val(h).prev().remove(),g.before(i);break;case e.list:g.select2("val",h);break;case e.formula:g.html(k.formula(b));break;default:g.val(h)}}),k&&_.each(k,function(a){var b=[];j._renderPanelListBody(b,a,h,a.readonly?"view":"edit"),j.$('[data-pid="'+a.id+'"] tbody').html(b.join(""))})}return this.setTitle()},setDefaults:function(){var a=this;return this.clear(),_.each(this.getFields(),function(b){b.hasOwnProperty("defaultvalue")&&a.setFieldValue(b.id,b.defaultvalue)}),this},setFieldValue:function(a,b){return this.$field(a).val(b),this},getFieldValue:function(a){return _.isString(a)?d.getFieldTypedValue(this._fieldHash[a],this.$field(a)):d.getFieldTypedValue(a,this.$field(a.id))},setFieldProp:function(b,c,d){if("value"===c)this.setFieldValue(b,d);else{var e=this.$field(b);switch(c){case"enabled":d?e.removeProp("disabled"):e.prop("disabled",!0);break;case"visible":a.setVisible(e,d)}}return this},getFieldProp:function(a,b){if("value"===b)this.setFieldValue(a,value);else{var c=this.$field(a);switch(b){case"enabled":return!c.prop("disabled");case"visible":return c.is(":visible");case"valid":}}},$field:function(a){return this.$("#"+this.fieldViewId(a))},clear:function(){var a,b,d=this,f=this.getSubCollecs();return this.clearMessages(),_.each(this.getFields(),function(f){if(a=d.$field(f.id),b=f.defaultvalue||"",f.readonly)a.html(b);else switch(f.type){case e.bool:a.prop("checked",b?"checked":!1);break;case e.list:a.select2("val",null);break;case e.pix:var g="<p>"+c.nopix+"</p>";a.val("").prev().remove(),a.before(g);break;default:a.val(b)}}),f&&_.each(f,function(a){d.$('[data-pid="'+a.id+'"] tbody').html(d._TRnodata(a.elements.length,"edit"))}),this},clearCache:function(){return this._fieldHash=null,this._fields=null,this._subCollecs=this._subCollecsOK=!1,this},getModelFieldValue:function(a,b,c){return this.model&&this.model.has(a)?"new"!==c?this.model.get(a):b||"":""},_showTab:function(a){var b=this.$(a);return b.length>0&&(b.siblings(".tab-pane").removeClass("active").hide(),b.addClass("active").show()),b=this.$('.evol-tabs > li > a[href="'+a+'"]').parent(),b.length>0&&(b.siblings("li").removeClass("active"),b.addClass("active").show()),this._tabId=a,this.$el.trigger("change.tab",{id:a}),this},_renderButtons:function(b,d){b.push(a.html.clearer,'<div class="evol-buttons panel panel-info">',a.button("cancel",c.bCancel,"btn-default"),a.button("save",c.bSave,"btn-primary")),this.model&&this.model.isNew()&&this.button_addAnother&&"json"!==d&&b.push(a.button("save-add",c.bSaveAdd,"btn-default")),b.push("</div>")},_render:function(b,c){var d=this,e=-1,f=-1,g=this.uiModel.elements,h=g.length-1;b.push('<div class="evo-one-',c,'">'),_.each(g,function(i,j){"tab"===i.type?(f>0&&(b.push("</div>"),f=-1),0>e&&(b.push(a.html.clearer),d._renderTabs(b,g),b.push('<div class="tab-content">')),e++,b.push('<div id="evol-tab-',j,'" class="tab-pane',0===e?' active">':'">'),d._renderTab(b,i,c),e==h&&b.push("</div>")):(0>f&&(b.push('<div class="evol-pnls">'),f=1),i.id||(i.id="p"+j),"panel-list"===i.type?d._renderPanelList(b,i,c):d._renderPanel(b,i,c))}),f>0&&b.push("</div>"),b.push("</div>"),this._renderButtons(b,c)},_renderTabs:function(a,b){var c=!0;a.push('<ul class="nav nav-tabs evol-tabs">'),_.each(b,function(b,d){"tab"===b.type&&(c?(a.push('<li class="active ',b.csslabel||"",'">'),c=!1):b.csslabel?a.push('<li class="',b.csslabel,'">'):a.push("<li>"),a.push('<a href="#evol-tab-',d,'">',b.label,"</a></li>"))}),a.push("</ul>")},_renderTab:function(b,c,d){var e=this;b.push('<div class="evol-pnls ',c.css||"",'">'),_.each(c.elements,function(a){"panel-list"===a.type?e._renderPanelList(b,a,d):e._renderPanel(b,a,d)}),b.push(a.html.clearer,"</div></div>")},_renderPanel:function(c,d,f,g){var h=this,i=this.iconsPath;if("wiz"===f){var j=_.isUndefined(g)?!1:!g;c.push('<div data-p-width="100" class="evol-pnl evo-p-wiz" style="width:100%;',j?"display:none;":"",'">')}else c.push('<div data-p-width="',d.width,'" class="evol-pnl'),"mini"===f?c.push(' evol-p-mini">'):c.push(' pull-left" style="width:',d.width,'%">');return c.push(a.HTMLPanelBegin(d,this.style||"panel-default"),'<fieldset data-pid="',d.id,d.readonly?'" disabled>':'">'),"mini"===f?_.each(d.elements,function(a){a.type==e.hidden?c.push(b.hidden(h.fieldViewId(a.id),h.getModelFieldValue(a.id,a.defaultvalue,f))):(c.push('<div class="pull-left evol-fld w-100">'),h.renderField(c,a,f,i),c.push("</div>"))}):_.each(d.elements,function(a){"panel-list"==a.type?h._renderPanelList(c,a,a.readonly?"view":f):a.type==e.hidden?c.push(b.hidden(h.fieldViewId(a.id),h.getModelFieldValue(a.id,a.defaultvalue,f))):(c.push('<div style="width:',parseInt(a.width||100,10),'%" class="pull-left evol-fld">'),h.renderField(c,a,f,i),c.push("</div>"))}),c.push("</fieldset>",a.HTMLPanelEnd(),"</div>"),this},_renderPanelList:function(b,c,d){var e=c.readonly?!1:"view"!==d,f=e?d:"view";return b.push('<div style="width:',c.width,'%" class="evol-pnl pull-left" data-pid="',c.id,'">',a.HTMLPanelBegin(c,this.style),'<table class="table" data-mid="',c.attribute||c.id,'"><thead><tr>'),_.each(c.elements,function(c){b.push("<th>",c.label,e&&c.required?a.html.required:"","</th>")}),"edit"===f&&b.push("<th></th>"),b.push("</tr></thead><tbody>"),this._renderPanelListBody(b,c,null,f),b.push("</tbody></table>",a.HTMLPanelEnd(),"</div>"),this},_renderPanelListBody:function(b,c,f,g){var h=this,i=c.elements,j=this.iconsPath||"",k="edit"===g&&!c.readonly;if(this.model){var l=this.model.get(c.attribute);if(l&&l.length>0){var m='<td class="evo-td-plusminus">'+a.buttonsPlusMinus()+"</td>";return void _.each(l,function(a,f){b.push('<tr data-idx="',f,'">'),k?(h._TDsFieldsEdit(b,c.elements,a),b.push(m)):_.each(i,function(c){b.push("<td>"),b.push(a[c.id]?c.type===e.bool||c.type===e.lov?d.HTMLField4Many(c,a[c.id],Evol.hashLov,j):_.escape(d.HTMLField4Many(c,a[c.id],Evol.hashLov,j)):_.escape(d.HTMLField4Many(c,"",Evol.hashLov,j))),b.push("</td>")}),b.push("</tr>")})}}b.push(this._TRnodata(i.length||1,g))},_TRnodata:function(b,d){return'<tr data-id="nodata"><td colspan="'+("edit"===d?b+1:b)+'" class="evol-pl-nodata">'+c.nodata+("edit"===d?a.buttonsPlus():"")+"</td></tr>"},_TDsFieldsEdit:function(a,b,c){var e,f=this.iconPath;_.each(b,function(b){e=c[b.id],_.isUndefined(e)&&(e=""),a.push("<td>",d.HTMLField4One(b,b.id,e,"edit-details",f,!0),"</td>")})},renderField:function(a,b,c,e){var f="";return this.model&&this.model.has(b.id)&&(f="new"!==c?this.model.get(b.id):b.defaultvalue||""),"formula"===b.type?(a.push(Evol.Dico.HTMLFieldLabel(b,c||"edit")),a.push('<div id="'+this.fieldViewId(b.id)+'" class="disabled evo-rdonly evol-ellipsis">'+(this.model?b.formula(this.model):"")+"</div>")):a.push(d.HTMLField4One(b,this.fieldViewId(b.id),f,c,e)),this},setTitle:function(b){if(this._uTitle){var c=this.titleSelector;if(c&&""!==c){var d,e=this.uiModel.leadfield;return d=b?b:_.isUndefined(e)||""===e?a.capitalize(this.uiModel.entities):this.getTitle(),$(c).text(d),this._uTitle=!0,this}this._uTitle=!1}return this},validate:function(a){var b,d=a?a:this.getFields(),e=this.getData(!0),f=[];if(this.clearMessages(),f=this._checkFields(d,e),b=""===f,this._subCollecs){var g=this;_.each(this._subCollecs,function(a){var d=e[a.id],h=g.$('[data-pid="'+a.id+'"] tbody > tr'),i=0;if(_.each(d,function(b,c){_.each(a.elements,function(a){g.validateField(a,b[a.id])&&(h.eq(c).find("#"+a.id).parent().addClass("has-error"),i++)})}),i>0){var j="validation.invalidList"+(1===i?"1":"");j=c.getLabel(j,i,a.label),f.push(j),b=!1}})}return this.$el.trigger("action","validate",{valid:b}),f},valRegEx:{email:/^[\w\.\-]+@[\w\.\-]+\.[\w\.\-]+$/,integer:/^[-+]?\d+$/,decimalEN:/(\+|-)?(\d*\.\d*)?$/},_checkFields:function(a,b){function c(a,b){_.isArray(g)&&g.push(b);var c=f.$field(a.id).parent();a.type===e.email&&(c=c.parent());var d=c.find(".text-danger");d.length?d.html(b):c.append('<p class="text-danger">'+b+"</p>"),c.addClass("has-error")}var d,f=this,g=[];return _.each(a,function(a){d=f.validateField(a,b[a.id]),""!==d&&c(a,d)}),g},validateField:function(a,b){function f(a,b,c,d){return b.replace("{0}",a).replace("{1}",c).replace("{2}",d)}var g=c.validation,h=d.isNumberType(a.type);if(!a.readonly){if(a.required&&(""===b||h&&isNaN(b)||a.type===e.lov&&"0"===b||a.type===e.list&&0===b.length||a.type===e.color&&"#000000"===b))return f(a.label,g.empty);if(!(isNaN(b)&&h||""===b||_.isArray(b)))switch(a.type){case e["int"]:case e.email:if(!this.valRegEx[a.type].test(b))return f(a.label,g[a.type]);break;case e.dec:case e.money:var i=this.valRegEx[e.dec+c.LOCALE]||this.valRegEx[e.dec+"EN"];if(!i.test(b))return f(a.label,g[a.type]);break;case e.date:case e.datetime:case e.time:if(""!==b&&!_.isDate(new Date(b)))return f(a.label,g[a.type])}if(null!==a.regex&&!_.isUndefined(a.regex)){var j=new RegExp(a.regex);if(!b.match(j))return f(a.label,g.regex,a.label)}if(h&&""!==b){if(a.max&&parseFloat(b)>a.max)return f(a.label,g.max,a.max);if(a.min&&parseFloat(b)<a.min)return f(a.label,g.min,a.min)}if(a.customvalidation){var k=a.customvalidation(a,b);if(""!==k)return f(a.label,k)}if(_.isString(b)){var l=b.length,m=a.maxlength?l>a.maxlength:!1,n=a.minlength?l<a.minlength:!1;if(m||n)return a.maxlength&&a.minlength?f(a.label,g.minmaxlength,a.minlength,a.maxlength):a.maxlength?f(a.label,g.maxlength,a.maxlength):f(a.label,g.minlength,a.minlength)}}return""},clearErrors:function(){return this.$(".control-group.error").removeClass("control-group error"),this.$(".has-error").removeClass("has-error"),this.$(".text-danger").remove(),this},fieldViewId:function(a){return this.prefix+"-"+a},showHelp:function(a,b,c,d){var e,f,g=_.findWhere(this.getFields(),{id:a});return g&&g.help&&(e=c.closest(".evol-fld"),f=d?[]:e.find(".help-block"),f.length>0?f.slideUp(200,function(){f.remove()}):(f=$('<span class="help-block">'+_.escape(g.help)+"</span>").hide(),e.append(f),f.slideDown(200))),this},clearMessages:function(){return this.$el.trigger("message",null),this.clearErrors()},sendMessage:function(a,b,c){return this.$el.trigger("message",{title:a,content:b,style:c})},setTab:function(a){this._showTab(a)},getTab:function(){return this._tabId},click_button:function(a){var b=$(a.currentTarget).data("id");a.stopImmediatePropagation(),this.$el.trigger("action",b)},click_toggle:function(a){var b=$(a.currentTarget),c=b.closest(".panel-heading").next(),d=c.data("expState"),e="glyphicon-chevron-up",f="glyphicon-chevron-down";if(a.preventDefault(),a.stopImmediatePropagation(),a.shiftKey){var g="down"===d?f:e;this.$(".evol-title-toggle."+g).trigger("click")}else"down"===d?(b.closest(".panel").css("height",""),c.slideDown(300).data("expState","up"),b.addClass(e).removeClass(f)):(c.slideUp(300,function(){b.closest(".panel").css("height","40px")}).data("expState","down"),b.removeClass(e).addClass(f));this.$el.trigger("toggle.panel")},click_tab:function(a){var b=a.currentTarget.href,c=b.substring(b.indexOf("#"));a.stopImmediatePropagation(),a.preventDefault(),a.shiftKey?this.$(".tab-content > div").show():this._showTab(c),this._tabId=c},click_help:function(a){var b="none",c=$(a.currentTarget),d=c.data("type");if(a.stopImmediatePropagation(),a.shiftKey){var e=this,f=!this._allHelp;f&&(this.$(".evol-fld>.help-block").remove(),this._allHelp=!0,b="all"),_.each(this.getFields(),function(a){if(a.help){var b=e.$field(a.id);e.showHelp(a.id,a.type,b,f)}}),this.$el.trigger(d+".help",{id:b})}else b=c.closest("label").attr("for"),this.showHelp(b,d,c),this.$el.trigger(d+".help",{id:b})},click_detailsAddDel:function(b){var c=$(b.currentTarget),d=c.data("id"),e=c.closest("tr");if(!b.keyCode||13===b.keyCode)if(b.stopImmediatePropagation(),"bPlus"===d){var f=[],g=this.getSubCollecs(),h=e.closest("table").data("mid"),i=g[h]?g[h].elements:null;f.push("<tr>"),this._TDsFieldsEdit(f,i,{}),f.push('<td class="evo-td-plusminus">',a.buttonsPlusMinus(),"</td></tr>"),$(f.join("")).insertAfter(e),"nodata"===e.data("id")&&e.remove()}else"bMinus"===d&&(0===e.siblings().length&&$(this._TRnodata(e.children().length,"edit")).insertAfter(e),e.remove())}})}(),Evol.ViewOne.Edit=Evol.ViewOne.extend({viewName:"edit",prefix:"oe",postRender:function(){var a="#"+this.prefix+"-",b=_.filter(this.getFields(),function(a){return"list"===a.type&&!a.readonly});_.each(b,function(b){this.$(a+b.id).select2({data:b.list,multiple:!0})})}}),Evol.ViewOne.JSON=Evol.ViewOne.extend({events:{"click > .evol-buttons > button":"click_button"},viewName:"json",render:function(){var a=[],b=Evol.UI;if(this.model){var c=JSON.stringify(this.model,null,2);a.push(b.label("uimjson","JSON"),b.input.textMJSON("uimjson",c,16)),this._renderButtons(a,"json")}else a.push(b.HTMLMsg(Evol.i18n.nodata,"","info"));return this.$el.html(a.join("")),this.setData(this.model),this},validate:function(){var a=!0,b=this.getData(),c=this._getDOMField().parent();return a=!Evol.UI.addRemClass(c,null===b,"has-error"),this.$el.trigger("action","validate",{valid:a}),a?[]:[Evol.i18n.validation.invalid]},getData:function(){var a,b=this._getDOMField().val();try{a=$.parseJSON(b)}catch(c){a=null}return a},setData:function(a){return this.clearError()._getDOMField().val(JSON.stringify(a,null,2)),this.setTitle()},clear:function(){return this._getDOMField().val(""),this},clearError:function(){return this._getDOMField().parent().removeClass("has-error"),this},_getDOMField:function(){return this.$el.children("textarea")}}),Evol.ViewOne.Mini=Evol.ViewOne.Edit.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click label > .glyphicon-question-sign":"click_help"},viewName:"mini",prefix:"om",fieldsetFilter:function(a){return(a.required||a.viewmany||a.viewmini)&&"formula"!=a.type},_render:function(a,b){var c={type:"panel","class":"evol-mini-holder",label:Evol.UI.capitalize(this.uiModel.entity),width:100,elements:this.getFields()};this._renderPanel(a,c,b),this._renderButtons(a,b)}}),Evol.ViewOne.View=Evol.ViewOne.extend({viewName:"view",editable:!1,prefix:"ovw",getData:function(){return{}},setData:function(a){if(!_.isUndefined(a)&&null!==a){var b,c,d=this,e=Evol.Dico.fieldTypes,f=Evol.Dico.HTMLField4Many,g="#"+d.prefix+"-",h=this.getSubCollecs(),i=this.iconsPath||"";_.each(this.getFields(),function(h){if(b=d.$(g+h.id),c=h.value?h.value(a):a.get(h.attribute||h.id),a)switch(h.type){case e.lov:case e.bool:case e.email:case e.url:case e.html:b.html(f(h,c,Evol.hashLov,i));break;case e.formula:b.html(h.formula(a));break;case e.pix:b.html(c?'<img src="'+i+c+'" class="img-thumbnail">':"<p>"+Evol.i18n.nopix+"</p>");break;case e.textml:b.html(c?_.escape(c).replace(/[\r\n]/g,"<br>"):"");break;default:b.text(f(h,c,Evol.hashLov,i)||" ")}}),h&&_.each(h,function(a){var b=[];d._renderPanelListBody(b,a,c,"view"),d.$('[data-pid="'+a.id+'"] tbody').html(b.join(""))})}return this.setTitle()},clear:function(){var a,b=this,c=Evol.Dico.fieldTypes,d="#"+b.prefix+"-",e=this.getSubCollecs();return this.clearMessages(),_.each(this.getFields(),function(e){switch(a=b.$(d+e.id),e.type){case c.bool:a.prop("checked",e.defaultvalue?"checked":!1);break;case c.pix:break;default:a.html(e.defaultvalue||"")}}),e&&_.each(e,function(a){b.$('[data-pid="'+a.id+'"] tbody').html(b._TRnodata(a.elements.length,"view"))}),this},_renderButtons:function(a){a.push(Evol.UI.html.clearer,'<div class="evol-buttons panel panel-info">',Evol.UI.button("cancel",Evol.i18n.bCancel,"btn-default"),Evol.UI.button("edit",Evol.i18n.bEdit,"btn-primary"),"</div>")}}),Evol.ViewAction.Export=function(){var a=Evol.UI,b=Evol.Dico,c=b.fieldTypes,d=a.input,e=Evol.i18n,f=e["export"],g={optEntityName:function(b,c,e){return a.fieldLabel(b,c)+d.text(b,e.replace(/ /g,"_"),30)+"<br>"},optsXML:function(a){return this.html_more2(f.options)+this.optEntityName("elementName",f.XMLroot,a)+"</div>"},optsSQL:function(b){return this.html_more2(f.options)+this.optEntityName("table",f.SQLTable,b)+"<div>"+d.checkbox("insertId","0")+a.fieldLabelSpan("insertId",f.SQLIdInsert)+"</div><div>"+d.checkbox("transaction","0")+a.fieldLabelSpan("transaction",f.SQLTrans)+"</div></div>"},optsHTML:function(){return""},optsJSON:function(){return""},html_more2:function(a){return'<a href="javascript:void(0)" class="evol-xpt-more">'+a+'</a><div style="display:none;">'}};return Backbone.View.extend({viewName:"export",cardinality:"n",events:{"change .evol-xpt-format":"click_format","change input":"click_preview","click .evol-xpt-more":"click_toggle_sel","click button":"click_button"},options:{model:null,uiModel:null,many:!0,sampleMaxSize:20,formats:["CSV","TAB","HTML","JSON","XML","SQL"]},initialize:function(a){return _.extend(this,this.options,a),this},render:function(){return this.$el.html(this._renderHTML()),this._preview(this.formats[0]),this},_renderHTML:function(){var b=[],c=this.formats,h=this.getFields(),i=h.length,j=i>14;b.push('<div class="evol-xpt-form"><div class="evol-xpt-flds">',"<div><label>",f.xpFields,"</label></div>",'<fieldset class="checkbox">'),b.push('<div><label><input type="checkbox" value="1" id="showID">',f.IDkey,"</label></div>"),_.each(h,function(a,c){var d=a.labelexport||a.label||a.labellist,e="fx-"+a.id;(null===d||""===d)&&(d="("+e+")"),b.push('<div><label><input type="checkbox" value="1" id="',e,'" checked="checked">',d,"</label></div>"),10===c&&j&&b.push(g.html_more2(f.allFields))}),j&&b.push("</div>"),b.push('</fieldset></div><div class="evol-xpt-para">');var k="evol-xpt-format",l=_.map(c,function(a){return{id:a,text:f["format"+a]}});return b.push('<label for="',k,'">',f.format,"</label>"),b.push(d.select(k,"","evol-xpt-format",!1,l)),k="xptFLH",b.push('<div class="evol-xpt-opts">','<div class="evol-FLH clearfix">',"<label>",d.checkbox(k,!0),f.firstLine,"</label>",'</div><div id="xptCSV">','<div data-id="csv2" class="evol-w120">',a.fieldLabel("separator",f.separator),d.text("separator",",","0"),"</div>","</div>"),_.each(c,function(a){b.push('<div id="xpt',a,'" style="display:none;"></div>')}),b.push("</div>","<label>",f.preview,'</label><div class="evol-xpt-preview">','<textarea class="evol-xpt-val form-control"></textarea>',"</div></div></div></div>",'<div class="evol-buttons form-actions">',a.button("cancel",e.bCancel,"btn-default"),a.button("export",f.DownloadEntity.replace("{0}",this.uiModel.entities),"btn btn-primary"),"</div>"),b.join("")},setModel:function(a){this.model=a},showFormatOpts:function(b){switch(b){case"TAB":b="CSV",this.$('[data-id="csv2"]').hide();break;case"CSV":this.$('[data-id="csv2"]').show();break;case"HTML":case"XML":case"SQL":case"JSON":var c=this.$("#xpt"+b);""===c.html()&&c.html(g["opts"+b](this.uiModel.entity))}var d=this.$("#xpt"+b).show().siblings().hide(),e=d.filter(".evol-FLH");a.setVisible(e,"TAB"===b||"CSV"===b||"HTML"===b)},getFields:function(){return this.fields||(this.fields=b.getFields(this.uiModel)),this.fields},getTitle:function(){var a=this.many?"ies":"y";return e.getLabel("export.ExportEntit"+a,this.uiModel["entit"+a])},_preview:function(a){this.$(".evol-xpt-val").html(this.exportContent(a))},exportContent:function(d){var f=[],g=this.sampleMaxSize-1;if(this.model&&this.model.collection){var h=this.model.collection.models,i=this.getFields(),j=this.$(".evol-xpt-flds > fieldset input:checked"),k={},l=this.$("#xptFLH").prop("checked"),m=this.$("#showID").prop("checked");_.each(j,function(a){k[a.id.substring(3)]=""}),i=_.filter(i,function(a){return a.id&&_.has(k,a.id)?!0:void 0});var n=i.length-1;switch(d){case"CSV":case"TAB":case"TXT":var o=a.trim(this.$("#separator").val());"TAB"==d&&(o="&#09;"),l&&(m&&f.push("ID",o),_.each(i,function(a,b){f.push(a.label),n>b&&f.push(o)}),f.push("\n")),_.every(h,function(a,b){return m&&f.push(a.id,o),_.each(i,function(b,d){var e=a.get(b.id);e&&(b.type===c.bool?f.push(e):(b.type==c.text||b.type==c.textml)&&e.indexOf(",")>-1?f.push('"',e.replace('"','\\"'),'"'):f.push(e)),n>d&&f.push(o)}),f.push("\n"),g>b}),f.push("\n");break;case"HTML":f.push("<table>\n"),l&&(f.push("<tr>\n"),m&&f.push("<th>ID</th>"),_.each(i,function(a){f.push("<th>",a.label,"</th>")}),f.push("\n</tr>\n")),_.every(h,function(a,b){return f.push("<tr>\n"),m&&f.push("<td>",a.id,"</td>"),_.each(i,function(b){var c=a.get(b.id);_.isUndefined(c)||""===c?f.push("<td></td>"):f.push("<td>",c,"</td>")}),f.push("\n</tr>\n"),g>b}),f.push("</table>\n");break;case"JSON":var p=_.map(i,function(a){return a.id});m&&p.unshift("id"),_.every(h,function(a,b){return f.push(JSON.stringify(_.pick(a.toJSON(),p),null,2)),g>b});break;case"SQL":var q=this.$("#transaction").prop("checked"),r=this.$("#insertId").prop("checked"),s=this.$("#table").val().replace(/ /g,"_"),t=["INSERT INTO ",s," ("];""===s&&(s=this.uiModel.entity.replace(/ /g,"_")),m&&t.push("ID, "),_.each(i,function(a,b){t.push(a.id),n>b&&t.push(", ")}),t.push(")\n VALUES ("),t=t.join(""),q&&f.push("BEGIN TRANSACTION\n"),r&&f.push("SET IDENTITY_INSERT ",s," ON;\n");var u;_.every(h,function(a,d){return f.push(t),m&&f.push('"',a.id,'", '),_.each(i,function(d,e){switch(u=a.get(d.id),d.type){case c["int"]:case c.dec:case c.money:f.push(u?u:"NULL");break;case c.bool:f.push("boolean"==typeof u?u:"NULL");break;case c.date:case c.datetime:case c.time:_.isUndefined(u)||""===u?f.push("NULL"):f.push('"',u.replace(/"/g,'""'),'"');break;case c.list:_.isUndefined(u)||""===u||_.isArray(u)&&0===u.length?f.push("NULL"):f.push('"',b.HTMLField4Many(d,u,Evol.hashLov,"").replace(/"/g,'""'),'"');break;default:_.isUndefined(u)?f.push('""'):f.push('"',u.replace(/"/g,'""'),'"')}n>e&&f.push(", ")}),f.push(");\n"),g>d}),r&&f.push("SET IDENTITY_INSERT ",s," OFF;\n"),q&&f.push("COMMIT TRANSACTION\n");break;case"XML":var v,w=this.$("#elementName").val()||this.uiModel.entity.replace(/ /g,"_");f.push("<xml>\n"),_.every(h,function(a,b){return f.push("<",w," "),m&&f.push('ID="',a.id,'" '),_.each(i,function(b){f.push(b.id,'="'),b.type===c.text||b.type===c.textml?(v=a.get(b.id),_.isArray(v)||_.isUndefined(v)||f.push(v.replace(/"/g,'\\"'))):f.push(a.get(b.id)),f.push('" ')}),f.push("></",w,">\n"),g>b}),f.push("</xml>")}}else f.push(e.nodata);return"JSON"===d&&this.many?"["+f.join(",\n")+"]":f.join("")},val:function(a){if(_.isUndefined(a)){for(var b=this.$("#evol-xpt-format").val(),c={format:b,fields:this._valFields(),options:{}},d=this.$("#xpt"+b+" input"),e=0,f=d.length;f>e;e++){var g,h=d.eq(e);g="checkbox"===h.attr("type")?h.prop("checked"):h.val(),c.options[h.attr("id")]=g}return"CSV"===c.format||"TAB"===c.format||"HTML"===c.format?(c.options.firstLineHeader=this.$("#xptFLH").prop("checked"),"TAB"===c.format&&delete c.options.separator):"HTML"===c.format&&delete c.options,c}return this},_valFields:function(){var a=[],b=this.$(".evol-xpt-flds input:checked");return _.each(b,function(b){a.push(b.id.substr(3))}),a},click_format:function(a){var b=$(a.currentTarget).val();"XML"===b&&this.$("#XML").html(g.optsXML(this.uiModel.entity)).show().siblings().not(".evol-FLH").hide(),this.showFormatOpts(b),this._preview(b),this.$el.trigger("change.export","format",b)},click_preview:function(){var a=this.$(".evol-xpt-format").val();this._preview(a)},click_toggle_sel:function(a){$(a.currentTarget).hide().next().slideDown()},click_button:function(a){var b=$(a.currentTarget).data("id");this.$el.trigger("action",b)}})}(),Evol.ViewAction.Filter=function(){var a=Evol.UI,b=a.input,c=Evol.Dico.fieldTypes,d=Evol.i18n.filters,e={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw"};return Backbone.View.extend({viewName:"filter",events:{"click .evo-bNew":"click_new","click .evo-bAdd":"click_add","click .evo-bSubmit":"click_submit","click .evo-zfilters>a>button":"click_remove","click .close":"click_close"},options:{fields:[],dateFormat:"mm/dd/yyyy",buttonLabels:!1,submitButton:!1,submitReady:!1},initialize:function(a){return _.extend(this,this.options,a),this.fields.length<1&&this.uiModel&&(this.fields=_.map(Evol.Dico.getFields(this.uiModel,function(a){return a.type!==c.hidden}),function(a){return a.type!==c.list?a:_.extend({},a,{type:c.lov,trueType:c.list})})),this},render:function(){var b=this.buttonLabels,f=this,g=this.$el,h=[];return h.push(Evol.UI.html.buttonClose+'<div class="evo-zfilters"></div>','<a class="evo-bNew btn btn-primary" href="javascript:void(0)">',d.bNewCond,"</a>"),this.submitButton&&h.push('<a class="evo-bSubmit btn btn-primary" href="javascript:void(0)">',d.bSubmit,"</a>"),h.push('<div class="evo-editFilter"></div>','<a class="evo-bAdd btn btn-primary" style="display:none;" href="javascript:void(0)">',d.bAddCond,"</a>",'<a class="evo-bDel btn btn-default" style="display:none;" href="javascript:void(0)">',d.bCancel,"</a>"),this._step=0,g.html(h.join("")),this.submitReady&&(this._hValues=$("<span></span>").appendTo(g)),this.submitButton&&(this._bSubmit=g.find(".evo-bSubmit").button({text:b})),this._bNew=g.find(".evo-bNew").button({text:b,icons:{secondary:"ui-icon-plusthick"}}),this._bAdd=g.find(".evo-bAdd").button({text:b,icons:{secondary:"ui-icon-check"}}),this._bDel=g.find(".evo-bDel").button({text:b,icons:{secondary:"ui-icon-close"}}).on("click",function(){f._removeEditor()}),this._editor=g.find(".evo-editFilter").on("change","#field",function(a){a.stopPropagation(),f._step>2&&f._editor.find("#value,#value2,.as-Txt").remove(),f._step>1&&(f._editor.find("#operator").remove(),f._bAdd.hide()),f._step=1;var b=$(a.currentTarget).val();if(""!==b){f._field=f._getFieldById(b);var d=f._type=f._field.type;f._setEditorOperator(),(d===c.lov||d===c.bool)&&f._setEditorValue()}else f._field=f._type=null}).on("change","#operator",function(a){a.stopPropagation(),f._operator=$(this).val(),f._step>2&&(f._editor.find("#value,#value2,.as-Txt").remove(),f._bAdd.hide(),f._step=2),f._setEditorValue()}).on("change keyup","#value,#value2",function(a){a.stopPropagation();var b=f._type,d=$(this).val(),g=""!==d||b===c.lov||b===c.bool;"number"==b?g=g&&!isNaN(d):f._operator==e.sBetween&&(g=""!==f._editor.find("#value").val()&&""!==f._editor.find("#value2").val()),g?(f._bAdd.button("enable"),13===a.which&&f._bAdd.trigger("click")):f._bAdd.button("disable")}).on("click","#checkAll",function(){var b=$(this);a.toggleCheckbox(b.siblings(),b.prop("checked"))}),this._filters=g.find(".evo-zfilters").on("click","a",function(){f._editCond($(this))}).on("click","a>button",function(a){a.stopPropagation();var b=$(this).parent();b.hasClass("ui-state-disabled")||b.fadeOut("slow",function(){b.remove(),f._triggerChange()})}),this},_getFieldById:function(a){if(!this._hash){this._hash={};for(var b=0,c=this.fields.length;c>b;b++)this._hash[this.fields[b].id]=this.fields[b]}return this._hash[a]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableCond(null,!1),this._bNew.removeClass("ui-state-active").show().focus(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this._step=0,this._field=this._type=this._operator=null},addCondition:function(a){$('<a href="javascript:void(0)">'+this._htmlCond(a)+"</a>").prependTo(this._filters).data("filter",a).fadeIn();return this._triggerChange(),this},removeCondition:function(a){return this._filters.children().eq(a).remove(),this._triggerChange(),this},_htmlCond:function(b){var c='<span class="evo-lBold">'+b.field.label+'</span> <span class="evo-lLight">'+b.operator.label+'</span> <span class="evo-lBold">'+b.value.label+"</span>";return b.operator.value==e.sBetween&&(c+='<span class="evo-lLight"> '+d.opAnd+' </span><span class="evo-lBold">'+b.value.label2+"</span>"),c+=a.html.buttonClose},_enableCond:function(a){this._cFilter&&(this._cFilter.removeClass("disabled"),a?(this._cFilter.data("filter",a).html(this._htmlCond(a)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editCond:function(a){var b=a.data("filter"),c=b.field.value,f=b.operator.value,g=b.value;this._enableCond(null,!1),this._removeEditor(),this._cFilter=a.addClass("disabled"),this._setEditorField(c),this._setEditorOperator(f),f==e.sBetween?this._setEditorValue(g.value,g.value2):this._setEditorValue(g.value),this._bAdd.find(".ui-button-text").html(d.bUpdateFilter),this._step=3},_setEditorField:function(a){if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),!this._fList){for(var c=this.fields,d=['<select id="field" class="form-control"><option value=""></option>'],e=0,f=c.length;f>e;e++){var g=c[e];d.push(b.option(g.id,g.label||g.labellist))}d.push("</select>"),this._fList=d.join("")}$(this._fList).appendTo(this._editor).focus()}a&&(this._field=this._getFieldById(a),this._type=this._field.type,this._editor.find("#field").val(a)),this._step=1},_setEditorOperator:function(a){var f=b.option,g=this._type;if(this._step<2){var h=[];switch(g){case c.lov:h.push(b.hidden("operator",e.sInList)),this._operator=e.sInList;break;case c.bool:h.push(b.hidden("operator",e.sEqual)),this._operator=e.sEqual;break;default:switch(h.push(b.selectBegin("operator","",!0)),g){case c.date:case c.datetime:case c.time:g==c.time?h.push(f(e.sEqual,d.sAt),f(e.sNotEqual,d.sNotAt)):h.push(f(e.sEqual,d.sOn),f(e.sNotEqual,d.sNotOn)),h.push(f(e.sGreater,d.sAfter),f(e.sSmaller,d.sBefore),f(e.sBetween,d.sBetween));break;case c["int"]:case c.dec:case c.money:h.push(f(e.sEqual,d.sNumEqual),f(e.sNotEqual,d.sNumNotEqual),f(e.sGreater,d.sGreater),f(e.sSmaller,d.sSmaller));break;default:h.push(f(e.sEqual,d.sEqual),f(e.sNotEqual,d.sNotEqual),f(e.sStart,d.sStart),f(e.sContain,d.sContain),f(e.sFinish,d.sFinish))}h.push(f(e.sIsNull,d.sIsNull),f(e.sIsNotNull,d.sIsNotNull)),h.push("</select>")}this._editor.append(h.join(""))}a&&g!=c.lov&&(this._editor.find("#operator").val(a),this._operator=a),this._step=2},_setEditorValue:function(a,f){var g=this._editor,h=this._type,i=g.find("#operator").val(),j=!1,k=!0;if(""!==i){if(h==c.lov||i!=e.sIsNull&&i!=e.sIsNotNull){if(this._step<3){var l=[];switch(j=i==e.sBetween,h){case c.lov:l.push('<section id="value">',this._field.list.length>7?'(<input type="checkbox" id="checkAll" value="1"/><label for="checkAll">All</label>) ':"",b.checkboxLOV(this._field.list),"</section>");break;case c.bool:l.push('<span id="value">',b.radio("value","1",d.yes,"0"!=a,"value1"),b.radio("value","0",d.no,"0"==a,"value0"),"</span>");break;case c.date:case c.datetime:case c.time:case c["int"]:case c.dec:case c.money:var m=h==c.date?"text":h;l.push('<input id="value" type="',m,'" class="form-control"/>'),j&&l.push('<span class="as-Txt">',d.opAnd," </span>",'<input id="value2" type="',m,'" class="form-control"/>'),k=!1;break;default:l.push('<input id="value" type="text" class="form-control"/>'),k=!1}g.append(l.join("")),h==c.date&&g.find("#value,#value2").datepicker({dateFormat:this.dateFormat})}if(a){var n=g.find("#value");switch(h){case c.lov:n.find("#"+a.split(",").join(",#")).prop("checked","checked");break;case c.bool:n.find("#value"+a).prop("checked","checked");break;default:n.val(a),k=""!==a,j&&(n.next().next().val(f),k=""!==a&&""!==f)}}else k=h==c.lov||h==c.bool}else g.append(b.hidden("value",""));this._bAdd.button(k?"enable":"disable").show(),this._step=3}},_getEditorData:function(){function a(a){var b=p.split("/");return b.length>2?b[2]+"-"+b[0]+"-"+b[1]:a}var b=this._editor,f=b.find("#field"),g=b.find("#value"),h={field:{label:f.find("option:selected").text(),value:f.val()},operator:{},value:{}},i=h.operator,j=h.value;
if(this._type==c.lov){var k=[],l=[];g.find("input:checked").not("#checkAll").each(function(){k.push(this.value),l.push(this.nextSibling.innerHTML)}),0===k.length?(i.label=d.sIsNull,i.value=e.sIsNull,j.label=j.value=""):1==k.length?(i.label=d.sEqual,i.value=e.sEqual,j.label='"'+l[0]+'"',j.value=k[0]):(i.label=d.sInList,i.value=e.sInList,j.label="("+l.join(", ")+")",j.value=k.join(","))}else if(this._type==c.bool){i.label=d.sEqual,i.value=e.sEqual;var m=g.find("#value1").prop("checked")?1:0;j.label=1==m?d.yes:d.no,j.value=m}else{var n=b.find("#operator"),o=n.val();if(i.label=n.find("option:selected").text(),i.value=o,o==e.sIsNull||o==e.sIsNotNull)j.label=j.value="";else{var p=g.val();switch(j.label=p,this._type){case c.text:j.value=p.toLocaleLowerCase();break;case c.date:case c.datetime:j.value=a(p);break;default:j.value=p}o==e.sBetween&&(p=g.next().next().val(),j.label2=p,this._type===c.date||this._type===c.datetime?(j.value2=a(p),j.label2=p):j.value2=p)}}return h},_hiddenValue:function(a,c,d){var e=b.hidden,f=c.value.value2;a.push(e("fld-"+d,c.field.value),e("op-"+d,c.operator.value),e("val-"+d,c.value.value)),f&&a.push(e("val2-"+d,f))},_setHiddenValues:function(){for(var a=this.val(),c=a.length,d=[b.hidden("elem",c)],e=0;c>e;e++)this._hiddenValue(d,a[e],e+1);this._hValues.html(d.join(""))},_triggerChange:function(){this.submitReady&&this._setHiddenValues(),this.$el.trigger("change.filter")},val:function(a){if(_.isUndefined(a)){var b=[];return this._filters.find("a").each(function(){b.push($(this).data("filter"))}),b}this._filters.empty();for(var c=0,d=a.length;d>c;c++)this.addCondition(a[c]);return this._triggerChange(),this},valText:function(){var a=[];return this._filters.find("a").each(function(){a.push(this.text)}),a.join(" "+d.opAnd+" ")},clear:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},click_new:function(){this._step<1&&(this._setEditorField(),this._step=1),this._bAdd.find(".ui-button-text").html(d.bAddCond)},click_add:function(){var a=this._getEditorData();this._cFilter?this._enableCond(a,this.highlight):this.addCondition(a),this._removeEditor()},click_remove:function(a){a.stopImmediatePropagation(),a.stopPropagation(),$(a.currentTarget).closest("a").remove(),this._triggerChange()},click_submit:function(){this.$el.trigger("submit.filter")},click_close:function(){this.$el.trigger("close.filter"),this.clear()}})}(),Evol.viewClasses={view:Evol.ViewOne.View,edit:Evol.ViewOne.Edit,mini:Evol.ViewOne.Mini,json:Evol.ViewOne.JSON,list:Evol.ViewMany.List,cards:Evol.ViewMany.Cards,charts:Evol.ViewMany.Charts,filter:Evol.ViewAction.Filter,"export":Evol.ViewAction.Export},Evol.ViewToolbar=function(){var a=Evol.UI,b=Evol.i18n;return Backbone.View.extend({events:{"click .nav a":"click_toolbar","navigate.many >div":"click_navigate","paginate.many >div":"paginate","change.tab >div":"change_tab","action >div":"action_view","status >div":"status_update","change.filter >div":"change_filter","close.filter >div":"hideFilter","click .alert-dismissable>button":"clearMessage","message >div":"showMessage"},options:{toolbar:!0,defaultView:"list",style:"panel-info",display:"label",titleSelector:"#title",pageSize:20,buttons:{always:[{id:"list",label:b.bList,icon:"th-list",n:"x"},{id:"new",label:b.bNew,icon:"plus",n:"x"}],actions:[{id:"edit",label:b.bEdit,icon:"edit",n:"1"},{id:"save",label:b.bSave,icon:"floppy-disk",n:"1"},{id:"del",label:b.bDelete,icon:"trash",n:"1"},{id:"filter",label:b.bFilter,icon:"filter",n:"n"},{id:"export",label:b.bExport,icon:"cloud-download",n:"n"}],prevNext:[{id:"prev",label:"",icon:"chevron-left",n:"x"},{id:"next",label:"",icon:"chevron-right",n:"x"}],views:[{id:"view",label:b.bView,icon:"eye-open",n:"1"},{id:"edit",label:b.bEdit,icon:"edit",n:"1"},{id:"mini",label:b.bMini,icon:"th-large",n:"1"},{id:"json",label:b.bJSON,icon:"barcode",n:"1"},{id:"list",label:b.bList,icon:"th-list",n:"n"},{id:"cards",label:b.bCards,icon:"th-large",n:"n"},{id:"charts",label:b.bCharts,icon:"stats",n:"n"}]}},initialize:function(a){_.extend(this,this.options,a),this.views=[],this.viewsHash={}},render:function(){return this.$el.html(this._toolbarHTML()),this.setView(this.defaultView||"list",!1),this.$(".dropdown-toggle").dropdown(),this},_toolbarHTML:function(){function b(a,b){return e.hItem(a.id,b?"":a.label,a.icon,a.n)}function c(a,c){return _.map(a,function(a){return b(a,c)}).join("")}var d,e=a.menu,f=this.buttons,g='<li class="divider-h"></li>';return d='<div class="evo-toolbar"><ul class="nav nav-pills pull-left" data-id="main">'+c(f.always)+g+c(f.actions),this.toolbar&&(d+='</ul><ul class="nav nav-pills pull-right" data-id="views"><li class="evo-tb-status" data-cardi="n"></li>',d+=c(f.prevNext),d+=g,d+=c(f.views,!0)),d+="</ul>"+a.html.clearer+"</div>"},refresh:function(){return this.curView&&this.curView.cardinality&&"n"===this.curView.cardinality&&this.curView.render(),this},isDirty:function(){return this.curView&&this.curView.isDirty&&this.curView.isDirty()?!0:!1},_setView:function(a,b,c){var d,e=this.$el,f="evolw-"+a,g=this.$('[data-vid="'+f+'"]'),h=this.curView,i=this._curCollec();if("new"===a)a=this._prevViewOne&&"view"!=this._prevViewOne&&"json"!=this._prevViewOne?this._prevViewOne:"edit",this.setView(a,!1,!0),this.model=new this.modelClass,this.model.collection=i,h.model=this.model,this.newItem(),this.setIcons("new"),h.mode="new";else if(g.length)this.model=h.model,h.model&&(this.model.collection=i),h=this.viewsHash[a],h.setCollection&&h.setCollection(i),this.model&&!this.model.isNew()?(h.setModel?(h.collection||(h.collection=this.model.collection),h.setModel(this.model)):h.model=this.model,h.setTitle&&h.setTitle(),this._tabId&&h.getTab&&this._tabId!=h.getTab()&&h.setTab(this._tabId),"n"===h.cardinality&&h.setPage&&this.pageIndex&&h.setPage(this.pageIndex)):h.clear&&h.clear(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),this.curView=h,this._keepTab(a),g.show().siblings().not(".evo-toolbar,.evo-filters,.clearfix").hide();else{if(g=$('<div data-vid="evolw-'+a+'"></div>'),e.children().not(".evo-toolbar,.evo-filters,.clearfix").hide(),e.append(g),d={el:g,mode:a,model:this.model,collection:i,uiModel:this.uiModel,style:this.style,pageSize:this.pageSize||20,pageIndex:this.pageIndex||0,titleSelector:this.titleSelector,router:this.router},this.$('[data-id="new"]').show(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),Evol.Dico.viewIsMany(a))h=new Evol.viewClasses[a](d).render(),this._prevViewMany=a,h.setTitle(),"charts"!=a&&"bubbles"!=a&&this.pageIndex>0&&h.setPage(this.pageIndex||0);else switch(a){case"export":d.sampleMaxSize=d.pageSize,h=new Evol.ViewAction.Export(d).render(),g.addClass("panel panel-info").slideDown();break;default:var j,k=null;h&&h.editable&&(k=h,j=h.getData()),h=new Evol.viewClasses[a](d).render(),this._prevViewOne=a,this._keepTab(a)}_.isUndefined(h)?alert("error: invalid route."):(this.curView=h,this.viewsHash[a]=h,c||$(this.titleSelector).html(h.getTitle()))}"n"===this.curView.cardinality?(this.setRoute("",!1),this._filterOn&&this.showFilter(!1),this.updateNav()):(b&&this.setRoute(this.model?this.model.id:null,!1),this.hideFilter(),this._enableNav()),c||this.setIcons(a)},setView:function(a,b,c){var d=this;return this.proceedIfReady(function(){d._setView(a,b,c)}),this},getView:function(){return this.curView},setTitle:function(){this.curView&&("export"===this.curView.viewName?$(this.titleSelector).html(this.curView.getTitle()):this.curView.setTitle())},proceedIfReady:function(b,c){var d,e,f=this,g=g;return this.isDirty()?(d=g.unSavedChanges.replace("{0}",this.curView.getTitle())+"<br><br>"+g.warnNoSave,e={nosave:b,ok:function(){0===f.curView.validate().length&&(f.saveItem(!1,!0),b())}},c&&(e.cancel=c),a.modal.confirm("isDirty",g.unSavedTitle,d,e,[{id:"nosave",text:g.bNoSave,"class":"btn-default"},{id:"cancel",text:g.bCancel,"class":"btn-default"},{id:"ok",text:g.bSave,"class":"btn-primary"}])):b(),this},_keepTab:function(a){!this.tabId||"view"!=a&&"edit"!=a||this.curView.setTab(this.tabId)},getToolbarButtons:function(){if(!this._toolbarButtons){var a=this.$(".evo-toolbar li"),b=this.$('.evo-toolbar [data-id="views"]');this._toolbarButtons={ones:a.filter('li[data-cardi="1"]'),manys:a.filter('li[data-cardi="n"]'),edit:a.filter('[data-id="main"]>[data-id="edit"]'),del:a.filter('[data-id="del"]'),save:a.filter('[data-id="save"]'),prevNext:this.$('.evo-toolbar [data-id="prev"],.evo-toolbar [data-id="next"]'),customize:this.$('.evo-toolbar a[data-id="customize"]').parent(),views:b,viewsIcon:this.$(".glyphicon-eye-open,.glyphicon-eye-close"),vws:b.find("ul>li>a")}}return this._toolbarButtons},setIcons:function(b){function c(a,b,c){d(e.ones,b),d(e.manys,c),e.vws.removeAttr("style"),e.views.find('[data-id="'+a+'"]>a').css("color","#428bca")}var d=a.setVisible;if(this.$el){var e=this.getToolbarButtons();if(e.prevNext.hide(),d(e.views,!("export"===b||"new"==b)),e.del.hide(),Evol.Dico.viewIsMany(b))if(this._prevViewMany=b,c(b,!1,!0),"charts"===b||"bubbles"===b)this.setStatus("");else{var f=this.collection.length,g=this.curView.pageSize;f>g&&e.prevNext.show()}else this.model&&this.model.isNew()||"new"===b||"export"===b?(c(b,!1,!1),e.del.hide(),e.views.hide(),d(e.save,"export"!==b)):(this._prevViewOne=b,c(b,!0,!1),e.prevNext.show(),d(e.save,"view"!==b),d(e.edit,"view"===b));d(e.manys.filter('[data-id="group"]'),"cards"===b)}},showFilter:function(b){if(this._filters)this._filters.$el.show();else if(b){var c=this,d=$(a.HTMLEmptyPanel("filters","evo-filters","info"));this.$(".evo-toolbar").after(d),this._filters=new Evol.ViewAction.Filter({el:d,uiModel:this.uiModel}).render(),d.on("change.filter",function(){c.curView.setFilter(c._filters.val()),"bubbles"!==c.curView.viewName&&c.curView.render()})}return this._filterOn=!0,this},hideFilter:function(){return this._filters&&this._filters.$el.hide(),this._filterOn=!1,this},_flagFilterIcon:function(b){a.addRemClass(this.$('a[data-id="filter"]'),b,"evo-filter-on")},toggleFilter:function(){return this._filterOn=!this._filterOn,this._filterOn?this.showFilter(!0):this.hideFilter()},setStatus:function(a){var b=this.$(".evo-toolbar .evo-tb-status");b.html(a)},setData:function(a){return this.curView&&this.curView.setData(a),this},getData:function(a){return this.curView?this.curView.getData(a):null},getCollection:function(){return this._curCollec()},setModelById:function(a){var b=this.collection.get(a);return _.isUndefined(b)?alert("Error: Invalid model ID."):(this.model=b,"1"!=this.curView.cardinality&&this.setView("view"),this.curView.setModel(b)),b},browse:function(a){var c=this._curCollec(),d=this.curView.model;if(d&&c&&c.length){var e=c.length-1,f=_.indexOf(c.models,d);f="prev"===a?f>0?f-1:e:e>f?f+1:0,d=c.models[f]}else d=null;return this.model=d,this.curView.setModel(d),d?this.setRoute(d?d.id:null,!1):this.setMessage(b.notFound,b.getLabel("notFoundMsg",this.uiModel.entity)),this.clearMessage()},setRoute:function(a,b){return Evol.Dico.setRoute(this.router,this.curView.getTitle(),this.uiModel.id,this.curView.viewName,a,b),this},saveItem:function(c,d){function e(a){c?(f.newItem(),this._trigger("item.added")):(a.unset(""),f.model=a,f._filteredCollection&&f._filteredCollection.add(a),f.setIcons("edit"),g.setModel(a),f._trigger("item.saved",{model:a,uiModel:f.uiModel})),g.setTitle()}var f=this,g=this.curView,h=d?[]:g.validate();if(0===h.length){var i=this.uiModel.entity;if(_.isUndefined(this.model)||this.model&&this.model.isNew()){var j=this.collection;j?(j.create(this.getData(!0),{success:function(c){e(c),f.setMessage(b.getLabel("saved",a.capitalize(i)),b.getLabel("status.added",i,_.escape(g.getTitle())),"success")},error:function(){alert('error in "saveItem"')}}),this.mode="edit"):alert("Can't save record b/c no collection is specified.")}else this.model.set(this.getData(!0)),this.model.save("","",{success:function(c){e(c),f.setMessage(b.getLabel("saved",a.capitalize(i)),b.getLabel("status.updated",a.capitalize(i),_.escape(g.getTitle())),"success")},error:function(){alert('error in "saveItem"')}})}else if(h.length>0){var k="<ul><li>"+h.join("</li><li>")+"</li></ul>";this.setMessage(b.validation.incomplete,k,"warning")}return this},newItem:function(){var a=this.curView;return"view"==a.viewName&&("view"!==this._prevViewOne&&"json"!==this._prevViewOne?this.setView(this._prevViewOne):this.setView("edit",!1,!0)),this.curView.setDefaults().setTitle(b.getLabel("NewEntity",this.uiModel.entity,a.getTitle()))},deleteItem:function(){var c=this,d=this.uiModel.entity,e=this.curView.getTitle();if("1"===this.curView.cardinality){var f=this.curView.model;f&&a.modal.confirm("delete",b.getLabel("deleteX",d),b.getLabel("delete1",d,_.escape(e)),{ok:function(){var g=c.collection,h=_.indexOf(g.models,f),i=h,j=null;g.length>1&&(i=0===h?1:h<g.length-1?h+1:h-1,j=g.at(i)),j&&(j.collection=g),f.destroy({success:function(){null===j||0===g.length?c.curView.clear():(c.model=j,c.curView.setModel(j));var f=a.capitalize(d);c.setMessage(b.getLabel("deleted1",f),b.getLabel("status.deleted",f,e),"success"),c._trigger("item.deleted")},error:function(){alert('error in "deleteItem"')}})}})}else if(c.curView.getSelection){var g=c.curView.getSelection();g.length>0&&confirm(b.getLabel("deleteN",g.length,c.uiModel.entities))}},setMessage:function(b,c,d){var e=this.$('[data-id="msg"]');return e.length?(e.attr("class","evo-msg alert alert-"+d+" alert-dismissable"),e.find(">strong").text(b),e.find(">span").eq(0).html(c),e.show()):$(a.HTMLMsg(b," "+c,d)).insertAfter(this.$el.children()[0]),this},clearMessage:function(){return this.$('[data-id="msg"]').remove(),this},showMessage:function(a,b){return b?this.setMessage(b.title,b.content,b.style):this.clearMessage()},action_view:function(b,c){switch(c){case"cancel":this.setView("1"!==this.curView.cardinality||this.model.isNew?this._prevViewMany||"list":this._prevViewOne||"view");break;case"edit":this.setView(c,!0);break;case"export":a.modal.alert("This feature must be implemented server side.",JSON.stringify(this.curView.val(),null,2));break;case"save":case"save-add":this.saveItem("save-add"===c)}},paginate:function(a,b){b&&(a=b.id);var c=this.pageIndex||0;if("prev"===a)c=c>0?c-1:0;else if("next"===a)(c+1)*this.pageSize<this.curView.collection.length&&c++;else{var d=parseInt(a,10);d>0&&(c=d-1)}return this.pageIndex=c,this.updateNav(),this.curView.setPage&&this.curView.setPage(c),this},updateNav:function(){var b=this.curView.collection.length,c="nav-disabled",d=this.pageIndex||0,e=this.$('[data-id="prev"]');a.addRemClass(e,0===d,c),a.addRemClass(e.next(),(d+1)*this.pageSize>b,c)},_enableNav:function(){this.$('[data-id="prev"],[data-id="next"]').removeClass("nav-disabled")},status_update:function(a,b){this.setStatus(b)},_curCollec:function(){return this._filteredCollection?this._filteredCollection:this.collection?this.collection:this.model?this.model.collection:new this.collectionClass},click_toolbar:function(a){var b=$(a.currentTarget);"A"!==b.tagName&&(b=b.closest("a"));var c=b.data("id");switch(a.preventDefault(),a.stopImmediatePropagation(),c){case"save":this.saveItem(!1);break;case"del":this.deleteItem();break;case"filter":this.toggleFilter();break;case"prev":case"next":if("1"===this.curView.cardinality){var d=this;this.proceedIfReady(function(){d.browse(c)})}else"n"===this.curView.cardinality&&this.paginate(c);break;default:c&&""!==c&&this.setView(c,!0)}this._trigger("toolbar."+c)},_trigger:function(a,b){this.$el.trigger(a,b)},click_navigate:function(a,b){a.stopImmediatePropagation(),this.setModelById(b.id),this.setRoute(b.id,!1)},change_tab:function(a,b){b&&(this._tabId=b.id)},change_filter:function(a){if("filter"===a.namespace){var b,c=this._filters.val();if(c.length){var d=Evol.Dico.filterModels(this.model.collection.models,c);b=this.collectionClass?new this.collectionClass(d):new Backbone.Collection(d),this._filteredCollection=b,this.setStatus(b.length+" / "+this.collection.length+" "+this.uiModel.entities)}else b=this.collection,this._filteredCollection=null,this.setStatus(b.length+" "+this.uiModel.entities);this._flagFilterIcon(c.length),this.pageIndex=0,this.curView.setCollection(b),this.updateNav(),this._trigger("filter.change")}}})}(),Evol.App=Backbone.View.extend({events:{},options:{elements:{nav:".evo-head-links",nav2:".evo-head-links2",content:"#evol"},useRouter:!0,pageSize:20,prefix:"evol-"},initialize:function(a){_.extend(this,this.options,a),this.uiModels=_.flatten(this.uiModelsObj),this._tbs={},this._ents={};var b=this.elements;this.$nav2=$(b.nav2),this.setupRouter()},setupRouter:function(){var a=this,b=Backbone.Router.extend({routes:{"":"nav",":entity(/:view)(/:id)":"nav","*noroute":a.noRoute},nav:function(b,c,d){b&&a.uiModelsObj[b]&&a.setEntity(b,c,d)}});this.router=new b,Backbone.history.start()},setRoute:function(a,b){var c=this._tbs[this._curEntity].curView;return c?Evol.Dico.setRoute(this.router,c.getTitle(),c.uiModel.id,c.viewName,a,b):alert("Error: Invalid route."),this},noRoute:function(a){alert('Error: Invalid route "'+a+'".')},setEntity:function(a,b,c){var d=this,e=this._tbs[this._curEntity],f=function(){d._setEntity(a,b,c)},g=function(){e&&e.curView&&d.setRoute(e.curView.model.id,!1)};this._curEntity?e?e.proceedIfReady(f,g):g():f()},_setEntity:function(a,b,c){function d(){e._ents[a].show().siblings().hide();var d=e._tbs[a];d&&(e._curEntity=a,d.curView.viewName!==b&&d.setView(b,!1,!1).setTitle(),c&&("1"===d.curView.cardinality?(d.setModelById(c),e.setRoute(c,!1)):e.setRoute("",!1)))}var e=this;if(b=b||"list",this._ents[a])d();else{var f=$('<div data-eid="'+a+'"></div>');this._ents[a]=f,this.$el.children().hide(),this.$el.append(f),this.createEntity(f,this.uiModelsObj[a],[],b,c,d)}return this._curEntity!==a&&(this.$nav2.find(">li>a").removeClass("sel").filter('[data-id="'+a+'"]').addClass("sel"),this._curEntity=a),this},createEntity:function(a,b,c,d,e,f){var g=this,h=new Backbone.LocalStorage(this.prefix+b.id),i=Backbone.Model.extend({localStorage:h}),j=Backbone.Collection.extend({model:i,localStorage:h}),k=new j;k.fetch({success:function(){var c=k.at(0),h={el:a,mode:"one",model:c,modelClass:i,collection:k,collectionClass:j,uiModel:b,pageSize:g.pageSize,titleSelector:"#title",style:g.style};d&&(h.defaultView=d),g.useRouter&&(h.router=g.router);var l=new Evol.ViewToolbar(h).render();e&&"1"===l.cardinality&&l.setModelById(e),g._tbs[b.id]=l,f&&f(l)},error:function(){alert("Error: invalid route.")}})}});